<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ChatGPT VR Viewer</title>
    <meta name="description" content="A simple VR app using A-Frame with a room, a cube, hand tracking controls, hand models, fog, and art exhibition lighting.">
    <script src="aframe-master.min.js"></script>
    <style>
      .drop-zone {
        position: fixed;
        width: 50%;
        height: 100%;
        border: dashed 4px #888;
        background-color: rgba(255, 255, 255, 0.5);
        display: none;
      }
      #drop-zone-model {
        top: 0;
        left: 0;
      }
      #drop-zone-environment {
        top: 0;
        right: 0;
      }

      #floating-menu,
      #floating-menu-load,
      #floating-info-box{
        position: fixed;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      #floating-menu-load {
        left:10px;
        right:auto;
      }
      #floating-menu-load .menu-button {
        background-color: #79ce12;
      }

      #floating-info-box {
        bottom:10px;
        left:10px;
        top:auto;
        font-size: 10px;
        color:#222;
      }
      #floating-info-box p {
        margin:0;
      }
      #floating-info-box p+p{
        margin-top:0.75em;
      }
      .menu-button {
        background-color: #4cc3d9;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        cursor: pointer;
      }

      #floating-menu-load .menu-button.red{
        background-color: #ff2266;
      }

      #floating-info-box {
        background-color: rgba(255, 255, 255, 0.3);
        padding: 10px;
        border-radius: 5px;
        max-width: 200px;
      }

      #move-light-button {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4cc3d9;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        cursor: pointer;
      }

       #popup-window {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      #popup-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      #close-popup {
        background-color: #4cc3d9;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
      }
    </style>

  </head>
  <body>
    <div id="popup-window">
      <div id="popup-content">
        <h1>Welcome to our VR App</h1>
        <p><small>VERSION 23-03-2023</small></p>
        <p>Created by:</p>
        <p>OpenAI's ChatGPT &amp; Krzysztof Krystian Jankowski</p>
        <button id="close-popup">Enter the App</button>
      </div>
    </div>

    <a-scene loading-screen="dotsColor: black; backgroundColor: white"
             renderer="antialias:true; colorManagement:true; physicallyCorrectLights:true; toneMapping:ACESFilmic; highRefreshRate:true;"
             shadow="castShadow:true; type:pcfsoft;"
             reflection>
      <a-sky id="hdr-sky" radius="300"></a-sky>

      <!-- Camera setup -->
      <a-entity id="cameraRig" movement-controls="speed: 0.1" position="0 1.6 3">
        <a-entity id="camera" camera position="0 0 0" camera-transform-updater></a-entity>
      </a-entity>

      <a-entity id="left-hand" oculus-touch-controls="hand: left" laser-controls="hand: left" raycaster="objects: .teleportable" teleport-controls="cameraRig: cameraRig; teleportOrigin: #camera; button: trackpad;" buttons-events></a-entity>
      <a-entity id="right-hand" laser-controls="hand: right"  oculus-touch-controls="hand: right" raycaster="objects: .teleportable" teleport-controls="cameraRig: cameraRig; teleportOrigin: #camera;" buttons-events></a-entity>

      <a-entity id="customModel" position="0 1 0" scale="1 1 1" shadow="receive:true; cast:true;"></a-entity>
      <a-entity id="customEnvironment" position="0 0 0" scale="1 1 1" shadow="receive:true; cast:false;"></a-entity>

      <!-- Lighting -->
      <a-light id="light1" position="-2 4 0" light="type:directional; castShadow:true; color:#FFF; intensity:4; target:#customModel; angle:30;"></a-light>
      <a-light id="light2" position="2 4 0" light="type:directional; castShadow:true; color:#FFF; intensity:4; target:#customModel; angle:30;"></a-light>
      <a-light id="light3" position="2 3 2" light="type:directional; castShadow:true; color:#FFF; intensity:4; target:#customModel; angle:160;"></a-light>
      <a-light type="ambient" color="#AAA" intensity="1"></a-light>
    </a-scene>

    <div id="floating-menu">
      <a class="menu-button" href="models/p1x.glb" download="p1x.glb">Download P1X model</a>
      <a class="menu-button" href="environments/a-vr-enviro-1.glb" download="a-vr-enviro-1.glb">Download Environment 1</a>
      <a class="menu-button" href="environments/a-vr-enviro-2.glb" download="a-vr-enviro-2.glb">Download Environment 2</a>
    </div>

    <div id="floating-menu-load">
      <button class="menu-button red" id="restore-controls" style="display:none;">RESTORE CAMERA CONTROLS</button>
      <button class="menu-button" id="load-model">Load next model</button>
      <button class="menu-button" id="load-enviro">Load next environment</button>
      <button class="menu-button" id="load-sky">Load next sky</button>
    </div>

    <div id="floating-info-box">
      <p>Source code available at <a href="https://github.com/w84death/ai-vr-viewer">github.com/w84death/ai-vr-viewer</a>.</p>
    </div>

    <button id="move-light-button">Move Light</button>

    <div id="drop-zone-model" class="drop-zone">
      <h1 style="text-align: center; margin-top: 40%;">Drop your model .glb file here</h1>
    </div>
    <div id="drop-zone-environment" class="drop-zone">
      <h1 style="text-align: center; margin-top: 40%;">Drop your environment .glb file here</h1>
    </div>

    <script>
      const environmentImages = [
        'environments/a-vr-enviro-0.glb',
        'environments/a-vr-enviro-1.glb',
        'environments/a-vr-enviro-2.glb',
      ];
      let currentEnvironmentIndex = 0;
      const skyImages = [
        'skys/sky1.jpg',
        'skys/sky2.jpg',
        'skys/sky3.jpg',
        'skys/sky4.jpg',
        'skys/sky5.jpg',
        'skys/sky6.jpg',
        'skys/sky7.jpg',
        'skys/sky8.jpg',
        'skys/sky9.jpg',
        'skys/sky10.jpg',
        'skys/sky11.jpg',
        'skys/sky12.jpg',
        'skys/sky13.jpg'
      ];
      let currentSkyIndex = 0;
      const modelImages = [
        'models/p1x.glb',
        'models/bolt.glb',
        'models/suzane.glb',
      ];
      let currentModelIndex = 0;

      const dropZoneModel = document.getElementById('drop-zone-model');
      const dropZoneEnvironment = document.getElementById('drop-zone-environment');

      function loadModel(url) {
        const model = document.getElementById('customModel');
        model.setAttribute('gltf-model', url);
      }

      function loadModelFromUrlHash() {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const modelFilename = params.get('model');

        if (modelFilename) {
          const modelUrl = `models/${modelFilename}.glb`;
          loadModel(modelUrl);
        } else {
          // Load the default model if no model parameter is provided
          loadModel(modelImages[currentModelIndex]);
        }
      }


        function loadNextModel() {
          currentModelIndex = (currentModelIndex + 1) % modelImages.length;
          const nextModelUrl = modelImages[currentModelIndex];
          loadModel(nextModelUrl);

          // Update the URL's hash
          const params = new URLSearchParams(window.location.hash.slice(1));
          const nextModelFilename = nextModelUrl.split('/').pop().split('.')[0];
          params.set('model', nextModelFilename);
          window.location.hash = params.toString();
        }


      function loadEnvironment(url) {
        const environment = document.getElementById('customEnvironment');
        environment.setAttribute('gltf-model', url);
      }

      function loadEnvironmentFromUrlHash() {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const environmentFilename = params.get('environment');

        if (environmentFilename) {
          const environmentUrl = `environments/${environmentFilename}.glb`;
          loadEnvironment(environmentUrl);
        } else {
          loadEnvironment(environmentImages[currentEnvironmentIndex]);
        }
      }


      function loadNextSky() {
        currentSkyIndex = (currentSkyIndex + 1) % skyImages.length;
        const nextSkyUrl = skyImages[currentSkyIndex];
        loadSky(nextSkyUrl);

        // Update the URL's hash
        const params = new URLSearchParams(window.location.hash.slice(1));
        const nextSkyFilename = nextSkyUrl.split('/').pop().split('.')[0];
        params.set('sky', nextSkyFilename);
        window.location.hash = params.toString();
      }

      function loadNextEnvironment() {
        currentEnvironmentIndex = (currentEnvironmentIndex + 1) % environmentImages.length;
        const nextEnvironmentUrl = environmentImages[currentEnvironmentIndex];
        loadEnvironment(nextEnvironmentUrl);

        // Update the URL's hash
        const params = new URLSearchParams(window.location.hash.slice(1));
        const nextEnvironmentFilename = nextEnvironmentUrl.split('/').pop().split('.')[0];
        params.set('environment', nextEnvironmentFilename);
        window.location.hash = params.toString();
      }



      document.getElementById('load-model').addEventListener('click', () => {
        loadNextModel();
      });

      document.getElementById('load-enviro').addEventListener('click', () => {
       loadNextEnvironment();
      });

      document.getElementById('load-sky').addEventListener('click', () => {
        loadNextSky();
      });

      document.getElementById('restore-controls').addEventListener('click', () => {
        restoreCameraControls();
      });


      document.addEventListener('dragover', (event) => {
        event.preventDefault();
        dropZoneModel.style.display = 'block';
        dropZoneEnvironment.style.display = 'block';
      });

      dropZoneModel.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dropZoneModel.style.display = 'none';
      });

      dropZoneEnvironment.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dropZoneEnvironment.style.display = 'none';
      });

      dropZoneModel.addEventListener('drop', async (event) => {
        event.preventDefault();
        dropZoneModel.style.display = 'none';
        dropZoneEnvironment.style.display = 'none';

        const file = event.dataTransfer.files[0];
        if (file && file.name.endsWith('.glb')) {
          const modelURL = URL.createObjectURL(file);
          const modelEntity = document.getElementById('customModel');
          modelEntity.setAttribute('gltf-model', modelURL);
        }
      });

      dropZoneEnvironment.addEventListener('drop', async (event) => {
        event.preventDefault();
        dropZoneModel.style.display = 'none';
        dropZoneEnvironment.style.display = 'none';

        const file = event.dataTransfer.files[0];
        if (file && file.name.endsWith('.glb')) {
          const environmentURL = URL.createObjectURL(file);
          const environmentEntity = document.getElementById('customEnvironment');
          environmentEntity.setAttribute('gltf-model', environmentURL);
        }
      });

      function randomPosition(radius) {
        const angle = Math.random() * 2 * Math.PI;
        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);
        const z = radius * Math.sin(angle);
        return { x, y, z };
      }

      function moveLights(lightIds) {
        const lightPositions = parseLightPositionsFromHash();

        lightIds.forEach((lightId) => {
          const light = document.getElementById(lightId);
          if (!light) return;

          const currentPosition = light.getAttribute('position');
          const newPosition = randomPosition(8);
          light.setAttribute('animation', {
            property: 'position',
            from: `${currentPosition.x} ${currentPosition.y} ${currentPosition.z}`,
            to: `${newPosition.x} ${newPosition.y} ${newPosition.z}`,
            dur: 3000,
            easing: 'easeInOutQuad',
          });

          // Update the light positions object
          lightPositions[lightId] = [newPosition.x, newPosition.y, newPosition.z];
        });

        // Update the URL's hash
        const params = new URLSearchParams(window.location.hash.slice(1));
        Object.entries(lightPositions).forEach(([key, value]) => {
          params.set(key, value.join(','));
        });
        window.location.hash = params.toString();
      }

      function applyLightPositionsFromHash() {
        const lightPositions = parseLightPositionsFromHash();
        Object.entries(lightPositions).forEach(([lightId, position]) => {
          const light = document.getElementById(lightId);
          if (light) {
            light.setAttribute('position', { x: position[0], y: position[1], z: position[2] });
          }
        });
      }

      document.getElementById('move-light-button').addEventListener('click', () => {
        moveLights(['light1', 'light2', 'light3']);
      });

      function loadSky(url) {
        const sky = document.querySelector('a-sky');
        sky.setAttribute('src', url);
      }

      AFRAME.registerComponent('buttons-events',{
        init: function () {
          this.el.addEventListener('abuttondown', this.changeSky);
          this.el.addEventListener('bbuttondown', this.changeLight);
          this.el.addEventListener('xbuttondown', this.changeModel);
          this.el.addEventListener('ybuttondown', this.changeEnviro);
        },
        changeSky: function(){
            loadNextSky()
        },
        changeLight: function(){
            moveLights(['light1', 'light2', 'light3']);
        },
        changeModel: function(){
            loadNextModel();
        },
        changeEnviro: function(){
            loadNextEnvironment();
        }
      });

      function loadSkyFromUrlHash() {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const skyFilename = params.get('sky');

        if (skyFilename) {
          const skyUrl = `skys/${skyFilename}.jpg`;
          loadSky(skyUrl);
        }
      }


      function parseLightPositionsFromHash() {
        const hash = window.location.hash.slice(1);
        const params = new URLSearchParams(hash);

        const lightPositions = {};
        params.forEach((value, key) => {
          if (key.startsWith('light')) {
            lightPositions[key] = value.split(',').map(parseFloat);
          }
        });

        return lightPositions;
      }

      function restoreCameraControls(){
        const camera = document.querySelector('#camera');
        const restore = document.querySelector('#restore-controls');
        camera.setAttribute('wasd-controls', '');
        camera.setAttribute('look-controls', '');
        restore.style.display="none";
      }

      function loadCameraTransformFromUrlHash() {
        const params = new URLSearchParams(window.location.hash.slice(1));
        const cameraPositionString = params.get('cameraPosition');
        const cameraRotationString = params.get('cameraRotation');

        const camera = document.querySelector('#camera');
        const restore = document.querySelector('#restore-controls');
        console.log(restore)
        if (cameraPositionString) {
          const cameraPosition = AFRAME.utils.coordinates.parse(cameraPositionString);
          camera.setAttribute('position', cameraPosition);
          restore.style.display="block";
        } else {
          camera.setAttribute('wasd-controls', '');
        }

        if (cameraRotationString) {
          const cameraRotation = AFRAME.utils.coordinates.parse(cameraRotationString);
          camera.setAttribute('rotation', cameraRotation);
          restore.style.display="block";
        }else{
          camera.setAttribute('look-controls', '');
        }
      }

      AFRAME.registerComponent('camera-transform-updater', {
        schema: {
          tickTimeout: { type: 'int', default: 1000 }
        },

        init: function () {
          this.previousPosition = this.el.getAttribute('position');
          this.previousRotation = this.el.getAttribute('rotation');
          this.lastUpdate = performance.now();
        },

        tick: function (time) {
          const currentPosition = this.el.getAttribute('position');
          const currentRotation = this.el.getAttribute('rotation');
          const timeSinceLastUpdate = time - this.lastUpdate;
          const shouldUpdateHash = timeSinceLastUpdate >= this.data.tickTimeout;

          if (shouldUpdateHash &&
              (AFRAME.utils.deepEqual(this.previousPosition, currentPosition) ||
              AFRAME.utils.deepEqual(this.previousRotation, currentRotation))) {

            const params = new URLSearchParams(window.location.hash.slice(1));
            params.set('cameraPosition', AFRAME.utils.coordinates.stringify(currentPosition));
            params.set('cameraRotation', AFRAME.utils.coordinates.stringify(currentRotation));
            window.location.hash = params.toString();

            this.previousPosition = currentPosition;
            this.previousRotation = currentRotation;
            this.lastUpdate = time;
          }
        }
      });




      document.getElementById('close-popup').addEventListener('click', () => {
        document.getElementById('popup-window').style.display = 'none';
      });

      loadCameraTransformFromUrlHash();
      loadModelFromUrlHash();
      loadEnvironmentFromUrlHash();
      loadSkyFromUrlHash();
      applyLightPositionsFromHash();
    </script>
  </body>
</html>
